\> æœ¬æ–‡ç”± \[ç®€æ‚¦ SimpRead\](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ \[juejin.im\](https://juejin.im/post/6884987711074091016)

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6927444c3cee4b07979deb57c2a974d7~tplv-k3u1fbpfcp-watermark.image)

å¯¼è¨€
==

æˆ‘ä»¬ç»å¸¸å¬åˆ°è¿™æ ·ä¸€å¥è¯ï¼ŒJavascript æ˜¯ä¸€é—¨åœ¨`å•çº¿ç¨‹`ç¯å¢ƒä¸‹è¿è¡Œçš„è¯­è¨€ï¼Œä»€ä¹ˆæ˜¯å•çº¿ç¨‹å‘¢ï¼Ÿå°±æ˜¯åŒä¸€æ—¶é—´åªèƒ½åšä¸€ä»¶äº‹é‚£ä¸ºä»€ä¹ˆä»–ä¸èƒ½è®¾è®¡æˆå¤šçº¿ç¨‹å‘¢ï¼Ÿè¿™æ ·å°±èƒ½åœ¨åŒä¸€æ—¶é—´åšå¤šä»¶äº‹ã€‚

æƒ³æ³•æ˜¯æŒºç¾å¥½çš„ï¼Œä½†æ˜¯å‘¢ï¼ŒJavascript çš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†`ä¸ç”¨æˆ·äº¤äº’`ï¼Œä»¥åŠ`æ“ä½œDOM`ï¼Œå‡è®¾æ˜¯å¤šçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹çš„å·¥ä½œæ˜¯åˆ é™¤æŸä¸ª DOM èŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä½œç”¨åˆæ˜¯åœ¨è¿™ä¸ªèŠ‚ç‚¹é‡Œé¢æ·»åŠ ä¸€äº›ä¸œè¥¿ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¯¥ä»¥å“ªä¸ªçº¿ç¨‹ä¸ºä¸»å‘¢ï¼Ÿï¼Ÿï¼Ÿ

æœ‰çš„äººå¯èƒ½ä¼šæƒ³åˆ° html5 çš„`web worker`ï¼Œä»–å…è®¸ Javascript è„šæœ¬åŒæ—¶åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œåœ¨ mdn ä¸­ï¼Œä»–æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e45c113f639a4e73a19ecfb73f67e441~tplv-k3u1fbpfcp-watermark.image) ä¹Ÿå°±æ˜¯è¯´ web workers æ˜¯å­çº¿ç¨‹ï¼Œç”±ä¸»çº¿ç¨‹æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ç›¸å½“äºä¸»çº¿ç¨‹çš„`è¾…åŠ©`ï¼Œä¸ºäº†é¿å…ä¸»çº¿ç¨‹è¢«`é˜»å¡`æˆ–è€…`å‡é€Ÿ`ã€‚

æµè§ˆå™¨ä¸‹çš„äº‹ä»¶å¾ªç¯æœºåˆ¶
===========

è°ƒç”¨æ ˆå’Œä»»åŠ¡é˜Ÿåˆ—
--------

æ ˆæ˜¯ä¸€ç§ç»“æ„åŒ–çš„å†…å­˜ï¼Œéµå¾ª LIFOï¼ˆå…ˆè¿›åå‡ºï¼‰çš„åŸåˆ™

é˜Ÿåˆ—ä¹Ÿæ˜¯ä¸€ç§ç»“æ„åŒ–çš„å†…å­˜å†…å­˜ï¼Œéµå¾ª FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰çš„åŸåˆ™

*   è°ƒç”¨æ ˆ

ä¸Šé¢è¯´çš„æ˜¯ä¸¤ç§å¸¸è§çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬çš„`è°ƒç”¨æ ˆ`ï¼ˆä¹Ÿå«æ‰§è¡Œæ ˆï¼‰å’Œä¸Šé¢çš„`æ ˆ`çš„å®šä¹‰åˆæœ‰ç‚¹ä¸åŒï¼Œå®ƒæŒ‡çš„æ˜¯ä¸€ç§ä»£ç çš„è¿è¡Œæ–¹å¼ï¼Œ ç»´åŸºç™¾ç§‘çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š

```
 a call stack is a stack data structure that stores information about the active subroutines of a computer program

the caller pushes the return address onto the stack, and the called subroutine, when it finishes, pulls or pops the return address off the call stack and transfers control to that address. If a called subroutine calls on yet another subroutine, it will push another return address onto the call stack, and so on.
å¤åˆ¶ä»£ç 

```

è¢«è°ƒç”¨å‡½æ•°æˆ–å­ä¾‹ç¨‹çš„`è¿”å›çš„åœ°å€`ä¼šè¢«æ¨å…¥æ‰§è¡Œæ ˆä¸­ï¼Œå½“è¿™ä¸ªè¿‡ç¨‹å®Œæˆåï¼Œè¿”å›çš„åœ°å€å°±ä¼šä»è°ƒç”¨æ ˆä¸­å¼¹å‡ºï¼Œå¹¶ä¸”å°†è¿™ç§æ§åˆ¶è°ƒç”¨æ ˆçš„æƒåˆ©`è½¬ç§»`ç»™è¯¥åœ°å€

å¦‚æœè°ƒç”¨å‡½æ•°ï¼ˆå­ä¾‹ç¨‹ï¼‰ä¸­åˆ`è°ƒç”¨`äº†å…¶ä»–å‡½æ•°ï¼ˆå­ä¾‹ç¨‹ï¼‰ï¼Œå°±åˆä¼š`é‡å¤`ä¸Šè¿°æ“ä½œã€‚

ä»¥å‡½æ•°ä¸¾ä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‡½æ•°è¢«`è°ƒç”¨`ä½¿ï¼Œä»–å°±ä¼š`è¿›å…¥`æ‰§è¡Œæ ˆï¼Œç„¶åæ‰§è¡Œå‡½æ•°ï¼Œé‡åˆ°`è¿”å›`ï¼ˆreturnï¼‰çš„æ—¶å€™ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«`å¼¹å‡ºæ ˆ`ï¼Œå¦‚æœå‡½æ•°è¿”å›çš„åˆæ˜¯ä¸€ä¸ª`å‡½æ•°`ï¼Œå°±ä¼šå®ç°ä¸€ç§`å±‚å±‚è°ƒç”¨`ã€‚

ä¸¾ä¸ªæ —å­ğŸŒ°

```
function one() {
  return 1;
}

function two() {
  return one() + 1;
}

function three() {
  return two() + 1;
}

console.log(three());

å¤åˆ¶ä»£ç 

```

ä»–çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼ˆåŠ¨å›¾æ¥æºäºä¸‹é¢ç¬¬å››ä¸ªå‚è€ƒé“¾æ¥ï¼‰ï¼š ![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/30736e4e6d22484fb1f0df69b90e647b~tplv-k3u1fbpfcp-watermark.image)

*   ä»»åŠ¡é˜Ÿåˆ—ï¼ˆtask queueï¼‰

javascript æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½æ˜¯`æ’é˜Ÿæ‰§è¡Œ`çš„ï¼Œåªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«å¤„ç†`å®Œæˆå`ï¼Œæ‰ä¼šå»å¤„ç†å¦ä¸€ä¸ªä»»åŠ¡ã€‚

å¦‚æœæœ‰çš„ä»»åŠ¡å¤„ç†éœ€è¦æ¶ˆè€—å¾ˆå¤šæ—¶é—´ï¼Œå°±ä¼šå¸¦æ¥`é˜»å¡`ã€‚

è€Œ javascript çš„ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯`éé˜»å¡`çš„ï¼Œå®ç°éé˜»å¡ä¸»è¦æ˜¯ä¾é `ä»»åŠ¡é˜Ÿåˆ—`è¿™ä¸€æœºåˆ¶ã€‚

Javascript å¼•æ“æ‰§è¡Œä»£ç æ˜¯ä¸€æ®µä¸€æ®µæ‰§è¡Œçš„ï¼Œåœ¨æ‰§è¡Œä¸€æ®µä»£ç æ—¶ï¼Œä»–ä¼šå…ˆåˆ¤æ–­æ‰€æ‰§è¡Œçš„ä»»åŠ¡æ˜¯åŒæ­¥ä»»åŠ¡ï¼ˆsynchronousï¼‰è¿˜æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼ˆasynchronousï¼‰ï¼Œå¦‚æœæ˜¯åŒæ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆç›´æ¥è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œå¾—åˆ°çš„`å›è°ƒå‡½æ•°`ï¼Œè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚

```
ä»»åŠ¡è¿›å…¥æ‰§è¡Œæ ˆä¸­ï¼Œåˆ¤æ–­æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥

è‹¥æ˜¯åŒæ­¥ï¼Œç›´æ¥è¿›å…¥ä¸»çº¿ç¨‹æŒ‰ç…§è°ƒç”¨æ ˆçš„é¡ºåºè¢«æ‰§è¡Œ

è‹¥æ˜¯å¼‚æ­¥ï¼Œåˆ™è¿›è¡Œä¸€äº›å¤„ç†ï¼Œå†å°†å›è°ƒå‡½æ•°æ¨å…¥ä»»åŠ¡é˜Ÿåˆ—

å½“ä¸»çº¿ç¨‹ä¸­çš„åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ‰§è¡Œæ ˆä¸ºç©ºï¼Œå¼€å§‹è¯»å–ä»»åŠ¡é˜Ÿåˆ—

ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¾æ¬¡è¿›å…¥æ‰§è¡Œæ ˆè¢«æ‰§è¡Œï¼Œç›´åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º

å®Œæˆ
å¤åˆ¶ä»£ç 

```

å¦‚å›¾ï¼š

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e48efcbb05964d31856e76ec2a719b06~tplv-k3u1fbpfcp-watermark.image)

å†ä¸¾ä¸ªæ —å­ğŸŒ°

```
1 console.log('a');

2 setTimeout(function () {
  console.log('b');
}, 4000);

3 setTimeout(function () {
  console.log('c');
}, 0);

4 console.log('d');
å¤åˆ¶ä»£ç 

```

æ‰§è¡Œçš„ç»“æœæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

`a d c b`

ä»»åŠ¡è¿›è¡Œæ‰§è¡Œæ ˆï¼Œé‡åˆ°`1`, æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œç«‹å³æ‰§è¡Œ äºæ˜¯ç­”æ¡ˆä¸­å°±æœ‰äº†`a` ï¼Œ

å†æ‰§è¡Œåˆ°`2`å’Œ`3`, æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œè¿›å…¥å¼‚æ­¥å¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†, ç”±äº`3`çš„ delay æ¯”`2`çŸ­ï¼Œ`3`çš„ç»“æœå…ˆè¿”å›ï¼Œ`3`æ¯”`2`çš„å›è°ƒå‡½æ•°å…ˆè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—

å†æ‰§è¡Œåˆ°`4`, æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œç«‹å³æ‰§è¡Œï¼Œäºæ˜¯ç­”æ¡ˆå˜æˆäº†`a d`

ç°åœ¨ä¸»çº¿ç¨‹çš„æ‰§è¡Œæ ˆä¸ºç©ºï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¾æ¬¡å…¥æ‰§è¡Œæ ˆæ‰§è¡Œ

æ‰€ä»¥æœ€ç»ˆç­”æ¡ˆä¸º`a d c b`

è¿™æ ·å°±ç»“æŸäº†ï¼Ÿï¼Ÿå½“ç„¶ä¸æ˜¯ğŸ‘»ğŸ‘»

*   å®ä»»åŠ¡ï¼ˆmacrotaskï¼‰å’Œå¾®ä»»åŠ¡ï¼ˆmicrotaskï¼‰

ä¸Šè¿°çš„å¼‚æ­¥ä»»åŠ¡åªæ˜¯ä¸€ä¸ªå®è§‚çš„æ¦‚å¿µï¼Œè‹¥å¯¹å¼‚æ­¥ä»»åŠ¡è¿›è¡Œç»†åˆ†çš„è¯ï¼Œåˆå¯ä»¥åˆ†ä¸ºå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ï¼Œä»–ä»¬ä¹‹é—´çš„æ‰§è¡Œé¡ºåºåˆæ˜¯ä¸åŒçš„ã€‚

åœ¨å¼‚æ­¥ä»»åŠ¡å›è°ƒå‡½æ•°è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—å‰ä¼šå¯¹è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡è¿›è¡Œåˆ¤æ–­çœ‹ä»–æ˜¯å®ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡

å®ä»»åŠ¡è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¾®ä»»åŠ¡è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—

åœ¨åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œä¼šå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå†æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡

å¾ªç¯å¾€å¤ï¼Œå®Œæˆï¼ï¼

å¸¸è§çš„å®ä»»åŠ¡

```
æ•´ä½“ä»£ç script
I/O
setTimeout
setInterval
requestAnimationFrame
å¤åˆ¶ä»£ç 

```

å¸¸è§çš„å¾®ä»»åŠ¡

```
MutationObserver
Promiseçš„å›è°ƒ
å¤åˆ¶ä»£ç 

```

å†ä¸¾ä¸ªæ —å­ğŸŒ°

```
1 console.log('a');

2 setTimeout(function () {
  console.log('b');
}, 0);

3 Promise.resolve()
  .then(function () {
    console.log('c');
  })
  .then(function () {
    console.log('d');
  });

4 console.log('e');
å¤åˆ¶ä»£ç 

```

æ‰§è¡Œçš„ç»“æœæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

`a e c d b`

ä»»åŠ¡è¿›è¡Œæ‰§è¡Œæ ˆï¼Œé‡åˆ°`1`, æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œç«‹å³æ‰§è¡Œ äºæ˜¯ç­”æ¡ˆä¸­å°±æœ‰äº†`a` ï¼Œ

å†æ‰§è¡Œåˆ°`2`, æ˜¯å¼‚æ­¥å®ä»»åŠ¡ï¼Œè¿›å…¥å¼‚æ­¥å¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†, ä»–çš„å›è°ƒå‡½æ•°è¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—

å†æ‰§è¡Œåˆ°`3`, æ˜¯å¼‚æ­¥å¾®ä»»åŠ¡ï¼Œè¿›å…¥å¼‚æ­¥å¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œä»–çš„å›è°ƒå‡½æ•°è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—

å†æ‰§è¡Œåˆ°`4`ï¼Œæ˜¯åŒæ­¥ä»»åŠ¡ï¼Œç«‹å³æ‰§è¡Œï¼Œç­”æ¡ˆå˜æˆ`a e`

ç°åœ¨ä¸»çº¿ç¨‹çš„æ‰§è¡Œæ ˆä¸ºç©ºï¼Œå…ˆå»æŸ¥çœ‹å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ`3`çš„å›è°ƒå‡½æ•°è¿›å…¥æ‰§è¡Œæ ˆæ‰§è¡Œï¼Œç­”æ¡ˆå˜æˆ`a e c`, è¿™ä¸ªå‡½æ•°è¿”å›'undefined', è§¦å‘ä¸‹ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”±äºå®ƒåˆæ˜¯å¼‚æ­¥å¾®ä»»åŠ¡ï¼Œè¿›å…¥å¼‚æ­¥å¤„ç†æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œä»–çš„å›è°ƒå‡½æ•°è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—

ç°åœ¨ä¸»çº¿ç¨‹ä¸­çš„æ‰§è¡Œæ ˆåˆä¸ºç©ºäº†ï¼Œåˆå»æŸ¥çœ‹å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ`3`çš„å›è°ƒçš„å›è°ƒè¿›å…¥æ‰§è¡Œæ ˆæ‰§è¡Œåå‡ºæ ˆï¼Œç­”æ¡ˆä¸º`a e c d`

ä¸»çº¿ç¨‹ä¸­çš„æ‰§è¡Œæ ˆåˆä¸ºç©ºäº†, é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿä¸ºç©ºï¼ŒæŸ¥çœ‹å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡

æœ€åç­”æ¡ˆä¸º`a e c d b`

å®Œæˆ âœ…

*   æ€è€ƒä¸€ä¸‹ğŸ¤”ï¼Œä¸‹é¢çš„ä»£ç æ‰§è¡Œé¡ºåºåˆæ˜¯æ€æ ·çš„å‘¢

```
console.log(0);

setTimeout(function () {
    console.log(1);
});

new Promise(function(resolve,reject){
    console.log(2)
    resolve(3)
}).then(function(val){
    console.log(val);
})

console.log(4);
å¤åˆ¶ä»£ç 

```

ç­”æ¡ˆæ˜¯

```
                                                                                                  0 2 4 3 1
å¤åˆ¶ä»£ç 

```

Node ä¸‹çš„äº‹ä»¶å¾ªç¯æœºåˆ¶
=============

process.nextTick å’Œ setImmediate
-------------------------------

Node ä¹Ÿæ˜¯å•çº¿ç¨‹çš„è¿è¡Œç¯å¢ƒï¼Œä»…ä»`api`çš„è§’åº¦æ¥è®²ï¼Œç›¸å¯¹äºæµè§ˆå™¨çš„ event loopï¼Œ å¤šäº†ä¸€ä¸ªå¾®ä»»åŠ¡çš„`process.nextTick`ä»¥åŠå®ä»»åŠ¡çš„`setImmediate`,

*   process.nextTick

process.nextTick çš„å›è°ƒå’Œ Promise çš„å›è°ƒéƒ½æ˜¯å¾®ä»»åŠ¡ï¼Œä½†æ˜¯ process.nextTick çš„å›è°ƒä¼šæ¯” Promise çš„å›è°ƒå…ˆæ‰§è¡Œ å¯¹äºä»¥ä¸‹ä»£ç 

```
process.nextTick(() => console.log(3));
Promise.resolve().then(() => console.log(4));
(() => console.log(5))();
å¤åˆ¶ä»£ç 

```

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6be3ce139d94440e8a388b5342319e5c~tplv-k3u1fbpfcp-watermark.image) äº¤æ¢ä½ç½®åï¼Œå¾—å‡ºæ¥åŒæ ·çš„ç»“æœ

```
process.nextTick(() => console.log(3));
Promise.resolve().then(() => console.log(4));
(() => console.log(5))();
å¤åˆ¶ä»£ç 

```

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5310098b89c47ccb59f743f5602c9fc~tplv-k3u1fbpfcp-watermark.image)

æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡èƒ½å¤Ÿå°½å¿«çš„æ‰§è¡Œï¼Œå°±å¯ä»¥ä½¿ç”¨`process.nextTick`

*   setImmediate `setImmediate`æ˜¯å®ä»»åŠ¡ï¼Œä»å®˜æ–¹çš„å®šä¹‰æ¥è®²ï¼Œ`setImmediate`ä¼šåœ¨ä¸€æ¬¡ Event loop ä¸­ç«‹å³æ‰§è¡Œï¼Œä½†ä»è¿è¡Œä¸Šæ¥è®²ï¼Œå¾—åˆ°çš„ç»“æœç¡®æ˜¯ä¸ä¸€å®šçš„ (åŸå› åœ¨åé¢)ï¼Œæ¯”å¦‚ä»¥ä¸‹ä»£ç ï¼š

```
setTimeout(() => console.log(1));
setImmediate(() => console.log(2));
å¤åˆ¶ä»£ç 

```

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f75187a08a65469199f6d5ca6c6f96be~tplv-k3u1fbpfcp-watermark.image)

äº‹ä»¶å¾ªç¯çš„é˜¶æ®µ
-------

*   äº‹ä»¶å¾ªç¯è§£æ

```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤åˆ¶ä»£ç 

```

*   é˜¶æ®µæ¦‚è¿°

`timers`: æ‰§è¡Œ`setTimeout()`å’Œ`setInterval()` çš„è°ƒåº¦ (çœ‹æ˜¯å¦æ»¡è¶³ delay çš„è¦æ±‚) çš„å›è°ƒå‡½æ•°ï¼Œä¸æ»¡è¶³å°†ç›´æ¥ç¦»å¼€è¿™ä¸ªé˜¶æ®µ

`I/O callbacks`: æ‰§è¡Œå»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾ªç¯è¿­ä»£çš„ I/O å›è°ƒ (ä¹Ÿå°±æ˜¯`é™¤äº†`ä»¥ä¸‹æ“ä½œä»¥å¤–çš„å›è°ƒ)

```
setTimeout()å’ŒsetInterval()çš„å›è°ƒå‡½æ•°
setImmediate()çš„å›è°ƒå‡½æ•°
ç”¨äºå…³é—­è¯·æ±‚çš„å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚socket.on('close', ...)
å¤åˆ¶ä»£ç 

```

`idle, prepare`: ä»… libuv ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨

`Poll`: è¿™ä¸ªé˜¶æ®µæ˜¯è½®è¯¢é˜¶æ®µ

```
åœ¨pollé˜Ÿåˆ—ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œä¼šæ£€ç´¢å¹¶æ‰§è¡Œæ–°çš„I/Oå›è°ƒäº‹ä»¶
å¦‚æœä¸ºç©ºï¼š
  è‹¥è°ƒç”¨äº†setImmediate()ï¼Œ å°±ç»“æŸpollé˜¶æ®µï¼Œç›´æ¥è¿›å…¥checké˜¶æ®µ,
  å¦‚æœæ²¡æœ‰è°ƒç”¨setImmediate()ï¼Œå°±ä¼šç­‰å¾…ï¼Œç­‰å¾…æ–°çš„å›è°ƒI/Oäº‹ä»¶çš„åˆ°æ¥ï¼Œç„¶åç«‹å³æ‰§è¡Œ
  å¦‚æœè„šæœ¬æ²¡æœ‰è°ƒç”¨äº†setImmediate()ï¼Œå¹¶ä¸”pollé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œäº‹ä»¶å¾ªç¯å°†æ£€æŸ¥å“ªäº›è®¡æ—¶å™¨ timer å·²ç»åˆ°æ—¶é—´ã€‚ å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªè®¡æ—¶å™¨ timer å‡†å¤‡å°±ç»ªï¼Œåˆ™äº‹ä»¶å¾ªç¯å°†è¿”å›åˆ°è®¡æ—¶å™¨é˜¶æ®µï¼Œä»¥æ‰§è¡Œè¿™äº›è®¡æ—¶å™¨çš„å›è°ƒï¼Œè¿™ä¹Ÿç›¸å½“äºå¼€å¯äº†æ–°ä¸€æ¬¡çš„å¾ªç¯ï¼ˆtickï¼‰

å¤åˆ¶ä»£ç 

```

`check`: åœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œ setImmediate() çš„å›è°ƒå‡½æ•°

`close callbacks`: æ‰§è¡Œå…³é—­è¯·æ±‚çš„å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚ socket.on('close', ...)

*   setTimeout å’Œ setImmediate

å›åˆ°ä¹‹å‰çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¿™ä¸¤å¥ä»£ç çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ä¸€æ ·çš„å‘¢ï¼Ÿ

```
setTimeout(() => console.log(1)ï¼Œ0);
setImmediate(() => console.log(2));
å¤åˆ¶ä»£ç 

```

ç…§ç†æ¥è¯´ï¼ŒsetTimeout åœ¨ timers é˜¶æ®µï¼Œå¹¶ä¸”å®ƒå›è°ƒæ‰§è¡Œçš„ delay å‚æ•°æ˜¯ 0ï¼Œè€Œ setImmediate åœ¨ check é˜¶æ®µï¼Œä½†æ˜¯ nodejs å®˜ç½‘å…³äº setTimeout çš„å®šä¹‰æœ‰è¿™æ ·ä¸€å¥è¯

`When delay is larger than 2147483647 or less than 1, the delay will be set to 1. Non-integer delays are truncated to an integer.`

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢è¿™ä¸¤ä¸ªè¡¨è¾¾å¼æ˜¯`ç­‰ä»·`çš„

`setTimeout(() => console.log(1)ï¼Œ0); === setTimeout(() => console.log(1)ï¼Œ1);`

è€Œå®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿›å…¥äº‹ä»¶å¾ªç¯ä»¥åï¼Œæœ‰å¯èƒ½åˆ°äº†`1ms`ï¼Œä¹Ÿæœ‰å¯èƒ½è¿˜æ²¡åˆ°ï¼Œè¿™å–å†³äºç³»ç»Ÿå½“æ—¶çš„çŠ¶å†µã€‚å¦‚æœæ²¡åˆ° 1msï¼Œå°±ä¼šè·³è¿‡`timers`ï¼Œå‘ä¸‹æ‰§è¡Œï¼Œåˆ°äº†`check`ï¼Œå…ˆæ‰§è¡Œ`setImmediate`ï¼Œç„¶åå†åœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­æ‰§è¡Œ`setTimeout`ã€‚

ä½†æ˜¯å¯¹äºä¸‹é¢çš„ä»£ç ï¼Œä¸€å®šä¼šå…ˆæ‰“å°`2`ï¼Œå†æ‰“å°`1`

```
const fs = require('fs');

fs.readFile('test.js', () => {
  setTimeout(() => console.log(1));
  setImmediate(() => console.log(2));
});
å¤åˆ¶ä»£ç 

```

ä»–çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¼šå…ˆè·³è¿‡ timers é˜¶æ®µï¼Œå›è°ƒç›´æ¥è¿›å…¥`I/0 callback`ï¼Œç„¶åå‘ä¸‹æ‰§è¡Œï¼Œåˆ°äº†`check`é˜¶æ®µæ‰§è¡Œ`setImmediate`ï¼Œç„¶åæ‰åœ¨ä¸‹ä¸€æ¬¡å¾ªç¯çš„ timers æ‰§è¡Œ`setTimeout`ã€‚

å‚è€ƒé“¾æ¥
====

[ç»´åŸºç™¾ç§‘ä¸­çš„è°ƒç”¨æ ˆ](https://en.wikipedia.org/wiki/Call_stack)

[Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)

[JavaScript è¿è¡Œæœºåˆ¶è¯¦è§£ï¼šå†è°ˆ Event Loop](https://www.ruanyifeng.com/blog/2014/10/event-loop.html)

[How JavaScript Works: An Overview of JavaScript Engine, Heap, and Call Stack](https://dev.to/bipinrajbhar/how-javascript-works-under-the-hood-an-overview-of-javascript-engine-heap-and-call-stack-1j5o)

[Node å®šæ—¶å™¨è¯¦è§£](http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html)

[node å®˜ç½‘å…³äº event loop çš„æœºåˆ¶](https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/)

[node å…³äº setTimeout çš„å®˜æ–¹æ–‡æ¡£](https://nodejs.org/api/timers.html#timers_settimeout_callback_delay_args)